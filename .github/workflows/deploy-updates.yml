name: Deploy Updates from Tauri App Releases

on:
  workflow_dispatch:
  # schedule:
  #  - cron: '0 0 * * *' # tous les jours à minuit

jobs:
  deploy:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - app: yapuka
            repo: breezeapps/Yapuka

    env:
      GH_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}

    steps:
      - name: 📦 Checkout this update repo (tauri-updates)
        uses: actions/checkout@v4

      - name: 🛠️ Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install -y gh

      - name: 🔐 Auth GH CLI + Get tag
        env:
            GITHUB_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}
        run: |
            tag=$(gh release view --repo "${{ matrix.repo }}" --json tagName -q '.tagName')
            echo "tag=$tag" >> $GITHUB_OUTPUT


      - name: 🧠 Get latest release tag
        id: get-tag
        env:
            GH_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}
        run: |
            tag=$(gh release view --repo "${{ matrix.repo }}" --json tagName -q '.tagName')
            echo "tag=$tag" >> $GITHUB_OUTPUT


      - name: 📥 Download release assets
        id: download-assets
        env:
            GH_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}
        run: |
            mkdir -p updates/${{ matrix.app }}
            gh release download ${{ steps.get-tag.outputs.tag }} \
            --repo "${{ matrix.repo }}" \
            --dir "updates/${{ matrix.app }}"

      - name: 🚀 Commit and push updates
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add updates/${{ matrix.app }}
          git commit -m "🔄 Update ${{ matrix.app }} to ${{ steps.get-tag.outputs.tag }}" || echo "Nothing to commit"
          git push
